name: CI
on:
  push:
  workflow_dispatch:
  schedule:
    # Every Sunday at 12PM UTC
    - cron: "0 12 * * 0"

jobs:
    version-check:
        runs-on: 'ubuntu-latest'
        outputs:
            bwz_latest_rls: ${{ steps.check.outputs.bwz_latest_rls }}
            vlt_latest_rls: ${{ steps.check.outputs.vlt_latest_rls }}
            rls_version: ${{ steps.check.outputs.rls_version }}
        steps:
        - name: fetch-version
          id: check
          run: |
            bwz_latest_rls=$(curl -s -L \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                https://api.github.com/repos/bitwuzla/bitwuzla/releases/latest | \
                jq ".tag_name" | sed -e 's/\"//g')
            
            # Get Verilator version from configure.ac on master branch (top-of-trunk)
            # The version is in AC_INIT([Verilator],[X.XXX ...], format
            vlt_version=$(curl -s -L \
                -H "Accept: application/vnd.github.raw+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                https://api.github.com/repos/verilator/verilator/contents/configure.ac?ref=master | \
                grep -E "^AC_INIT" | sed -E 's/AC_INIT\(\[Verilator\],\[([0-9]+\.[0-9]+).*/\1/')
            
            # Use master branch for top-of-trunk builds
            vlt_latest_rls="master"

            echo "bwz_latest_rls: ${bwz_latest_rls}"
            echo "vlt_version: ${vlt_version}"
            echo "vlt_latest_rls: ${vlt_latest_rls}"

            echo "bwz_latest_rls=${bwz_latest_rls}" >> ${GITHUB_OUTPUT}
            echo "vlt_latest_rls=${vlt_latest_rls}" >> ${GITHUB_OUTPUT}

            rls_version="${vlt_version}.${{ github.run_id }}"
            echo "rls_version=${rls_version}" >> ${GITHUB_OUTPUT}

            cat ${GITHUB_OUTPUT}
        - name: print
          run: |
            echo "bwz_latest_rls: ${{ steps.check.outputs.bwz_latest_rls }}"
            echo "vlt_latest_rls: ${{ steps.check.outputs.vlt_latest_rls }}"
            echo "rls_version: ${{ steps.check.outputs.rls_version }}"


    # Temporarily disabled for testing Windows builds
    # build-linux-x86_64:
    #     runs-on: 'ubuntu-latest'
    #     needs: version-check
    #     strategy:
    #       matrix:
    #         image: [manylinux2014_x86_64, manylinux_2_28_x86_64, manylinux_2_34_x86_64]
    #     steps:
    #         - uses: actions/checkout@v4
    #         - name: print
    #           run: |
    #             echo "print"
    #             echo "image: ${{ matrix.image }}"
    #             echo "bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}"
    #             echo "vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}"
    #         - name: build
    #           env:
    #             GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #             BUILD_NUM: ${{ github.run_id }}
    #             image: ${{ matrix.image }}
    #             bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}
    #             vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}
    #           run: >
    #             docker run --rm
    #             --volume "$(pwd):/io"
    #             --env BUILD_NUM
    #             --env vlt_latest_rls
    #             --env bwz_latest_rls
    #             --env image
    #             --workdir /io
    #             quay.io/pypa/${{ matrix.image }}
    #             /io/scripts/build.sh
    #         - name: upload artifact
    #           uses: actions/upload-artifact@v4
    #           with:
    #             name: "verilator-${{ matrix.image }}"
    #             path: "release/verilator-${{ matrix.image }}-*.tar.gz"
    #             if-no-files-found: error
    #             retention-days: 7

    # build-linux-arm64:
        runs-on: 'ubuntu-24.04-arm'
        needs: version-check
        strategy:
          matrix:
            image: [manylinux_2_28_aarch64, manylinux_2_34_aarch64]
        steps:
            - uses: actions/checkout@v4
            - name: print
              run: |
                echo "print"
                echo "image: ${{ matrix.image }}"
                echo "bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}"
                echo "vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}"
            - name: build
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                BUILD_NUM: ${{ github.run_id }}
                image: ${{ matrix.image }}
                bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}
                vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}
              run: >
                docker run --rm
                --volume "$(pwd):/io"
                --env BUILD_NUM
                --env vlt_latest_rls
                --env bwz_latest_rls
                --env image
                --workdir /io
                quay.io/pypa/${{ matrix.image }}
                /io/scripts/build.sh
            - name: upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: "verilator-${{ matrix.image }}"
                path: "release/verilator-${{ matrix.image }}-*.tar.gz"
                if-no-files-found: error
                retention-days: 7

    # build-macos-arm64:
    #     runs-on: 'macos-14'
    #     needs: version-check
    #     steps:
    #         - uses: actions/checkout@v4
    #         - name: Install dependencies
    #           run: |
    #             brew install autoconf automake bison flex help2man python3
    #             echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
    #             echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
    #         - name: print
    #           run: |
    #             echo "bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}"
    #             echo "vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}"
    #         - name: build
    #           env:
    #             GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #             BUILD_NUM: ${{ github.run_id }}
    #             image: macos-arm64
    #             bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}
    #             vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}
    #             FLEX: /opt/homebrew/opt/flex/bin/flex
    #             BISON: /opt/homebrew/opt/bison/bin/bison
    #             LEX: /opt/homebrew/opt/flex/bin/flex
    #             YACC: /opt/homebrew/opt/bison/bin/bison
    #           run: |
    #             export PATH="/opt/homebrew/opt/flex/bin:/opt/homebrew/opt/bison/bin:$PATH"
    #             export LDFLAGS="-L/opt/homebrew/opt/flex/lib"
    #             export CPPFLAGS="-I/opt/homebrew/opt/flex/include"
    #             ./scripts/build.sh
    #         - name: upload artifact
    #           uses: actions/upload-artifact@v4
    #           with:
    #             name: "verilator-macos-arm64"
    #             path: "release/verilator-macos-arm64-*.tar.gz"
    #             if-no-files-found: error
    #             retention-days: 7

    publish:
        runs-on: 'ubuntu-latest'
        needs: 
        # - build-linux-x86_64
        # - build-linux-arm64
        # - build-macos-arm64
        - build-windows-mingw
        - build-windows-cygwin
        - version-check
        permissions:
            contents: write
        steps:
        - name: Create Release
          id: create_release
          uses: actions/create-release@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
          with:
            tag_name: "v${{ needs.version-check.outputs.rls_version }}"
            release_name: "Release v${{ needs.version-check.outputs.rls_version }}"
            body: |
              Build of Verilator from top-of-trunk (master branch)
              Version: ${{ needs.version-check.outputs.rls_version }}
            draft: false
            prerelease: true
        - name: Download build artifacts
          uses: actions/download-artifact@v4
          with:
            pattern: "verilator-*"
            path: release
            merge-multiple: true

        - name: Upload assets to release
          uses: softprops/action-gh-release@v2
          with:
            tag_name: "v${{ needs.version-check.outputs.rls_version }}"
            files: |
              release/**/*.tar.gz
            fail_on_unmatched_files: true

    build-windows-mingw:
        runs-on: windows-latest
        needs: version-check
        strategy:
          matrix:
            include:
              - msystem: MINGW64
                arch: x86_64
                platform: mingw64
              - msystem: MINGW32
                arch: i686
                platform: mingw32
        steps:
            - uses: actions/checkout@v4
            - uses: msys2/setup-msys2@v2
              with:
                msystem: ${{ matrix.msystem }}
                update: false
                install: >-
                    base-devel
                    mingw-w64-${{ matrix.arch }}-toolchain
                    mingw-w64-${{ matrix.arch }}-cmake
                    mingw-w64-${{ matrix.arch }}-python
                    git
            - name: Install additional packages
              shell: msys2 {0}
              run: |
                pacman -S --noconfirm \
                  mingw-w64-${{ matrix.arch }}-meson \
                  mingw-w64-${{ matrix.arch }}-ninja \
                  mingw-w64-${{ matrix.arch }}-flex \
                  mingw-w64-${{ matrix.arch }}-bison \
                  mingw-w64-${{ matrix.arch }}-gmp \
                  mingw-w64-${{ matrix.arch }}-mpfr \
                  autoconf automake tar help2man
            - name: print
              run: |
                echo "msystem: ${{ matrix.msystem }}"
                echo "platform: ${{ matrix.platform }}"
                echo "bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}"
                echo "vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}"
            - name: build
              shell: msys2 {0}
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                BUILD_NUM: ${{ github.run_id }}
                image: ${{ matrix.platform }}
                bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}
                vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}
              run: |
                ./scripts/build.sh
            - name: upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: "verilator-${{ matrix.platform }}"
                path: "release/verilator-${{ matrix.platform }}-*.tar.gz"
                if-no-files-found: error
                retention-days: 7
            - name: create pacman package
              if: matrix.msystem == 'MINGW64'
              shell: msys2 {0}
              run: |
                ./scripts/create-pacman-package.sh ${{ needs.version-check.outputs.rls_version }} ${{ matrix.platform }}
            - name: upload pacman package
              if: matrix.msystem == 'MINGW64'
              uses: actions/upload-artifact@v4
              with:
                name: "verilator-${{ matrix.platform }}-pacman"
                path: "release/*.pkg.tar.zst"
                if-no-files-found: error
                retention-days: 7

    build-windows-cygwin:
        runs-on: windows-latest
        needs: version-check
        strategy:
          matrix:
            include:
              - arch: x86_64
                platform: cygwin64
              - arch: x86
                platform: cygwin32
        steps:
            - uses: actions/checkout@v4
            - uses: cygwin/cygwin-install-action@v4
              with:
                platform: ${{ matrix.arch }}
                packages: >-
                  gcc-core
                  gcc-g++
                  make
                  cmake
                  flex
                  bison
                  autoconf
                  automake
                  help2man
                  python39
                  python39-pip
                  git
                  tar
                  gzip
                  libgmp-devel
                  libmpfr-devel
            - name: print
              run: |
                echo "platform: ${{ matrix.platform }}"
                echo "bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}"
                echo "vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}"
            - name: build
              shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                BUILD_NUM: ${{ github.run_id }}
                image: ${{ matrix.platform }}
                bwz_latest_rls: ${{ needs.version-check.outputs.bwz_latest_rls }}
                vlt_latest_rls: ${{ needs.version-check.outputs.vlt_latest_rls }}
                CHERE_INVOKING: 1
              run: |
                cd "$GITHUB_WORKSPACE"
                ./scripts/build.sh
            - name: upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: "verilator-${{ matrix.platform }}"
                path: "release/verilator-${{ matrix.platform }}-*.tar.gz"
                if-no-files-found: error
                retention-days: 7
